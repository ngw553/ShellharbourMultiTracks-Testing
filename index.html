<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Church Band Multitrack Player</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0; padding: 0;
        background: #f4f4f4;
    }
    header {
        background: #222;
        color: #fff;
        padding: 10px;
        text-align: center;
    }
    .track {
        background: white;
        padding: 10px;
        margin: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .controls {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
        margin-top: 5px;
    }
    .controls label {
        font-size: 0.9em;
    }
    .slider {
        flex: 1;
        min-width: 80px;
    }
    .meter {
        width: 8px;
        height: 30px;
        background: #ddd;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }
    .meter-fill {
        background: #4caf50;
        width: 100%;
        height: 0%;
        position: absolute;
        bottom: 0;
        transition: height 0.05s linear;
    }
    .waveform {
        width: 100%;
        height: 80px;
    }
    button {
        padding: 6px 12px;
        font-size: 0.9em;
    }
    @media (max-width: 600px) {
        .controls {
            flex-direction: column;
            align-items: stretch;
        }
    }
</style>
</head>
<body>
<header>
    <h1>Church Band Multitrack Player</h1>
</header>
<main id="trackContainer"></main>

<script src="https://unpkg.com/wavesurfer.js"></script>
<script>
/* --- SONG/STEM DATA --- */
const songs = {
  "Hail The King": {
    folder: "HailTheKing",
    stems: [
      { file: "Drums.mp3",  name: "Drums" },
      { file: "Bass.mp3",   name: "Bass" },
      { file: "Guitar.mp3", name: "Acoustic Guitar" },
      { file: "Piano.mp3", name: "Piano" },
      { file: "Violin.mp3",   name: "Violin" },
      { file: "Vocal.mp3", name: "Vocal" },
      { file: "Electric Guitar.mp3", name: "Electric Guitar" },
      // { file: "BackingVocal.mp3",    name: "Backing Vocal" },
      { file: "Click.mp3",  name: "Click", muted: true }
    ]
};

// Current song
const currentSong = songs["Hail The King"];

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let playing = false;
let trackData = [];

function createTrackElement(trackInfo) {
    const container = document.createElement("div");
    container.className = "track";

    const title = document.createElement("h3");
    title.textContent = trackInfo.name;
    container.appendChild(title);

    const waveformDiv = document.createElement("div");
    waveformDiv.className = "waveform";
    container.appendChild(waveformDiv);

    const controls = document.createElement("div");
    controls.className = "controls";

    const muteBtn = document.createElement("button");
    muteBtn.textContent = "Mute";
    controls.appendChild(muteBtn);

    const soloBtn = document.createElement("button");
    soloBtn.textContent = "Solo";
    controls.appendChild(soloBtn);

    const volSlider = document.createElement("input");
    volSlider.type = "range";
    volSlider.min = 0; volSlider.max = 1; volSlider.step = 0.01;
    volSlider.value = 1;
    volSlider.className = "slider";
    controls.appendChild(volSlider);

    const meter = document.createElement("div");
    meter.className = "meter";
    const meterFill = document.createElement("div");
    meterFill.className = "meter-fill";
    meter.appendChild(meterFill);
    controls.appendChild(meter);

    container.appendChild(controls);
    document.getElementById("trackContainer").appendChild(container);

    // WaveSurfer visual
    const ws = WaveSurfer.create({
        container: waveformDiv,
        waveColor: '#999',
        progressColor: '#4caf50',
        height: 80,
        responsive: true,
        cursorWidth: 1,
        interact: false // user can't scrub independently
    });
    ws.load(trackInfo.file);

    // Web Audio for volume/meter
    const trackSource = audioCtx.createBufferSource();
    fetch(trackInfo.file)
        .then(res => res.arrayBuffer())
        .then(buf => audioCtx.decodeAudioData(buf))
        .then(decoded => {
            trackSource.buffer = decoded;
            trackSource.loop = false;
        });

    const gainNode = audioCtx.createGain();
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    const dataArray = new Uint8Array(analyser.frequencyBinCount);

    trackSource.connect(gainNode).connect(analyser).connect(audioCtx.destination);

    // Controls
    volSlider.addEventListener("input", () => {
        gainNode.gain.value = parseFloat(volSlider.value);
    });

    muteBtn.addEventListener("click", () => {
        gainNode.gain.value = gainNode.gain.value > 0 ? 0 : volSlider.value;
    });

    soloBtn.addEventListener("click", () => {
        trackData.forEach(t => {
            t.gainNode.gain.value = (t === track) ? volSlider.value : 0;
        });
    });

    const track = { ws, gainNode, analyser, dataArray, meterFill, volSlider, trackSource };
    trackData.push(track);
}

currentSong.forEach(createTrackElement);

// Master Play/Pause
const playBtn = document.createElement("button");
playBtn.textContent = "Play";
playBtn.style.margin = "20px";
playBtn.style.fontSize = "1.2em";
playBtn.addEventListener("click", () => {
    if (!playing) {
        audioCtx.resume();
        trackData.forEach(t => {
            const src = audioCtx.createBufferSource();
            src.buffer = t.trackSource.buffer;
            src.loop = false;
            src.connect(t.gainNode);
            t.src = src;
            src.start(0);
            t.ws.play();
        });
        playing = true;
        playBtn.textContent = "Pause";
    } else {
        trackData.forEach(t => {
            t.src.stop();
            t.ws.pause();
        });
        playing = false;
        playBtn.textContent = "Play";
    }
});
document.body.insertBefore(playBtn, document.getElementById("trackContainer"));

// Loudness meter loop
function updateMeters() {
    trackData.forEach(t => {
        t.analyser.getByteFrequencyData(t.dataArray);
        let sum = 0;
        for (let i = 0; i < t.dataArray.length; i++) sum += t.dataArray[i];
        const avg = sum / t.dataArray.length;
        const percent = Math.min(100, (avg / 255) * 100);
        t.meterFill.style.height = percent + "%";
    });
    requestAnimationFrame(updateMeters);
}
updateMeters();
</script>
</body>
</html>
